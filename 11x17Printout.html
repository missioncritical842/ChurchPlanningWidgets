<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Printable Service Sheet Widget (Upcoming Sunday v1.3)</title>
  <!-- External Grist API Script -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* Reset and Base Styles */
    body {
      margin: 0;
      padding: 0;
      background-color: #525659; /* Dark grey background like a PDF viewer */
      font-family: Arial, sans-serif;
    }

    /* The Page Container */
    .page {
      width: 17in;
      height: 11in;
      margin: 0.5in auto; /* Center on screen with spacing */
      padding: 0.5in;     /* Internal padding for content */
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Drop shadow */
      box-sizing: border-box; /* Include padding in width/height */
      position: relative;
      overflow: hidden; /* Prevent spillover */
      
      /* Typography setup */
      font-size: 48px;
      line-height: 1.3;
    }

    /* Styles inside the page */
    .label {
      display: inline-block;
      width: 300px;
      font-family: Calibri, sans-serif;
      font-weight: bold;
      font-size: 72px;
      vertical-align: top;
    }
    
    .scripture-heading {
      font-family: Calibri, sans-serif;
      font-weight: bold;
      font-size: 72px;
      text-decoration: underline;
      margin-bottom: 20px;
      margin-top: 20px;
    }
    
    .bigText {
      font-size: 112px;
      font-family: "Arial Narrow", sans-serif;
      font-weight: bold;
    }

    .song-row {
      margin-bottom: 10px;
    }

    /* Print Specific Styles */
    @media print {
      body {
        background-color: white;
        margin: 0;
      }
      .page {
        margin: 0;
        box-shadow: none;
        page-break-after: always;
        width: 17in;
        height: 11in;
      }
      /* Ensure the last page doesn't produce a blank extra sheet */
      .page:last-child {
        page-break-after: auto;
      }
    }
  </style>
</head>
<body>

  <div id="output">Loading...</div>

  <script>
    // --- Configuration ---
    const TABLE_PLAN = "Weekly_Church_Plan";
    const TABLE_SONGS = "Songs";
    const DOC_ID = "edUb9YnSZWnD";

    // Column Constants
    const COL_SUNDAY = "Sunday";
    const COL_PSALM = "Psalm";
    const COL_OT = "Old_Testament";
    const COL_NT = "New_Testament";
    const COL_GOSPEL = "Gospel";
    const COL_SONG_1 = "Song_1";
    const COL_SONG_2 = "Song_2";
    const COL_SONG_3 = "Song_3";
    const COL_SONG_4 = "Song_4";
    const COL_SONG_5 = "Song_5";
    const COL_SONG_6 = "Song_6";

    const COL_SONG_NAME = "Song_List";

    // Helper: Parse a "YYYY-MM-DD" string or timestamp into a Date using UTC.
    function parseUTCDate(dateInput) {
      if (!dateInput) return null;
      if (typeof dateInput === "number") {
        return new Date(dateInput * 1000);
      }
      if (typeof dateInput === "string") {
        var parts = dateInput.split("-");
        return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
      }
      return new Date(Date.UTC(dateInput.getUTCFullYear(), dateInput.getUTCMonth(), dateInput.getUTCDate()));
    }
    
    // Get today's date in UTC at midnight.
    function getTodayUTC() {
      var now = new Date();
      return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }
    
    // Compute the upcoming Sunday in UTC.
    function getUpcomingSundayUTC() {
      var today = getTodayUTC();
      var day = today.getUTCDay(); 
      var diff = (7 - day) % 7;
      var upcoming = new Date(today.getTime() + diff * 24 * 60 * 60 * 1000);
      return upcoming;
    }

    // Helper to convert Grist column-oriented data
    function convertToRecords(data) {
      const columns = Object.keys(data);
      if (columns.length === 0) return [];
      if (Array.isArray(data)) return data;

      const numRows = data.id ? data.id.length : 0;
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(col => {
          if (col !== 'id') {
             record[col] = data[col][i];
          }
        });
        records.push(record);
      }
      return records;
    }
    
    // Generate printable content for one record.
    function generateContent(record, songsMap) {
      function extractSong(songId) {
        if (!songId) return "";
        if (typeof songId === 'object' && songId.id) songId = songId.id;
        const songRec = songsMap[songId];
        return songRec ? (songRec[COL_SONG_NAME] || "") : "";
      }

      var song1 = extractSong(record[COL_SONG_1]);
      var song2 = extractSong(record[COL_SONG_2]);
      var song3 = extractSong(record[COL_SONG_3]);
      var song4 = extractSong(record[COL_SONG_4]);
      var song5 = extractSong(record[COL_SONG_5]);
      var song6 = extractSong(record[COL_SONG_6]);
      
      var psalm = record[COL_PSALM] || "";
      var ot = record[COL_OT] || "";
      var nt = record[COL_NT] || "";
      var gospel = record[COL_GOSPEL] || "";
      
      // PAGE 1: Songs 1-3, Psalm, OT
      var page1 = `
        <div class="page">
          <div class="song-row"><span class="label">Song 1:</span><span class="bigText">${song1}</span></div>
          <div class="song-row"><span class="label">Song 2:</span><span class="bigText">${song2}</span></div>
          <div class="song-row"><span class="label">Song 3:</span><span class="bigText">${song3}</span></div>
          
          <div class="scripture-heading">Scripture Readings</div>
          
          <div class="song-row"><span class="label">Psalm:</span><span class="bigText">${psalm}</span></div>
          <div class="song-row"><span class="label">OT:</span><span class="bigText">${ot}</span></div>
        </div>
      `;

      // PAGE 2: NT, Gospel, Songs 4-6
      var page2 = `
        <div class="page">
          <div class="song-row"><span class="label">NT:</span><span class="bigText">${nt}</span></div>
          <div class="song-row"><span class="label">Gospel:</span><span class="bigText">${gospel}</span></div>
          
          <br><br> <!-- Spacer to visually separate, similar to original flow -->
          
          <div class="song-row"><span class="label">Song 4:</span><span class="bigText">${song4}</span></div>
          <div class="song-row"><span class="label">Song 5:</span><span class="bigText">${song5}</span></div>
          <div class="song-row"><span class="label">Song 6:</span><span class="bigText">${song6}</span></div>
        </div>
      `;
      
      return page1 + page2;
    }

    async function fetchTableRest(tableName) {
      const url = `https://docs.getgrist.com/api/docs/${DOC_ID}/tables/${tableName}/records`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch ${tableName}: ${response.status}`);
      const json = await response.json();
      return json.records.map(r => ({ id: r.id, ...r.fields }));
    }
    
    async function loadData() {
      try {
        let planRecords, songsRecords;
        try {
          if (window.parent === window) throw new Error("Standalone");
          const [planData, songsData] = await Promise.all([
            grist.docApi.fetchTable(TABLE_PLAN),
            grist.docApi.fetchTable(TABLE_SONGS)
          ]);
          planRecords = convertToRecords(planData);
          songsRecords = convertToRecords(songsData);
        } catch (e) {
          console.log("Widget API failed or standalone mode, trying REST API...");
          [planRecords, songsRecords] = await Promise.all([
            fetchTableRest(TABLE_PLAN),
            fetchTableRest(TABLE_SONGS)
          ]);
        }

        const songsMap = {};
        songsRecords.forEach(s => { songsMap[s.id] = s; });

        var upcoming = getUpcomingSundayUTC();
        var filtered = planRecords.filter(function(rec) {
          var recDate = parseUTCDate(rec[COL_SUNDAY]);
          if (!recDate) return false;
          return recDate.getUTCFullYear() === upcoming.getUTCFullYear() &&
                 recDate.getUTCMonth() === upcoming.getUTCMonth() &&
                 recDate.getUTCDate() === upcoming.getUTCDate();
        });

        if (filtered.length === 0) {
          document.getElementById("output").innerHTML = "<div class='page' style='padding: 2in; text-align:center;'>No record for upcoming Sunday (" + upcoming.toLocaleDateString() + ").</div>";
        } else {
          document.getElementById("output").innerHTML = generateContent(filtered[0], songsMap);
        }

      } catch (err) {
        console.error(err);
        document.getElementById("output").innerHTML = "<div class='page' style='color:red; padding: 2in;'>" + err.message + "</div>";
      }
    }

    grist.ready({
      columns: [],
      requiredAccess: "read table"
    });
    
    loadData();
  </script>
</body>
</html>