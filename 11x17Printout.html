<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Printable Service Sheet Widget (Upcoming Sunday)</title>
  <!-- External Grist API Script -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* Set up the page for two 11x17 sheets in landscape */
    @page {
      size: 17in 11in;
      margin: 0.5in;
    }
    /* Base styles for printing */
    body {
      font-family: Arial, sans-serif;
      font-size: 48px;
      margin: 0;
      padding: 20px;
      line-height: 1.3; /* Increased spacing between lines */
    }
    /* Intro text: Calibri Bold, 72px, with fixed width to align dynamic text */
    .label {
      display: inline-block;
      width: 300px; /* Adjust this width if needed */
      font-family: Calibri, sans-serif;
      font-weight: bold;
      font-size: 72px;
    }
    /* Scripture Readings heading: full width, underlined, 72px */
    .scripture-heading {
      font-family: Calibri, sans-serif;
      font-weight: bold;
      font-size: 72px;
      text-decoration: underline;
      margin-bottom: 10px;
    }
    /* The dynamic content (song names and scripture readings): Arial Narrow Bold, 112px */
    .bigText {
      font-size: 112px;
      font-family: "Arial Narrow", sans-serif;
      font-weight: bold;
    }
    /* Ensure our output container handles line breaks */
    #output {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="output">Loading...</div>
  <script>
    // --- Configuration ---
    const TABLE_PLAN = "Weekly_Church_Plan";
    const TABLE_SONGS = "Songs";
    const DOC_ID = "edUb9YnSZWnD"; // Required for standalone mode

    // Column Constants
    const COL_SUNDAY = "Sunday";
    const COL_PSALM = "Psalm";
    const COL_OT = "Old_Testament";
    const COL_NT = "New_Testament";
    const COL_GOSPEL = "Gospel";
    const COL_SONG_1 = "Song_1";
    const COL_SONG_2 = "Song_2";
    const COL_SONG_3 = "Song_3";
    const COL_SONG_4 = "Song_4";
    const COL_SONG_5 = "Song_5";
    const COL_SONG_6 = "Song_6";

    // Songs Table Columns
    const COL_SONG_NAME = "Song_Name";

    // Helper: Parse a "YYYY-MM-DD" string or timestamp into a Date using UTC.
    function parseUTCDate(dateInput) {
      if (!dateInput) return null;
      if (typeof dateInput === "number") {
        return new Date(dateInput * 1000);
      }
      if (typeof dateInput === "string") {
        var parts = dateInput.split("-");
        // Create a Date in UTC (month is 0-indexed).
        return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
      }
      // If already a Date, force it to UTC midnight.
      return new Date(Date.UTC(dateInput.getUTCFullYear(), dateInput.getUTCMonth(), dateInput.getUTCDate()));
    }
    
    // Get today's date in UTC at midnight.
    function getTodayUTC() {
      var now = new Date();
      return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }
    
    // Compute the upcoming Sunday in UTC.
    function getUpcomingSundayUTC() {
      var today = getTodayUTC();
      var day = today.getUTCDay(); // 0 = Sunday, 1 = Monday, etc.
      var diff = (7 - day) % 7;
      var upcoming = new Date(today.getTime() + diff * 24 * 60 * 60 * 1000);
      return upcoming;
    }

    // Helper to convert Grist column-oriented data
    function convertToRecords(data) {
      const columns = Object.keys(data);
      if (columns.length === 0) return [];
      if (Array.isArray(data)) return data;

      const numRows = data.id ? data.id.length : 0;
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(col => {
          if (col !== 'id') {
             record[col] = data[col][i];
          }
        });
        records.push(record);
      }
      return records;
    }
    
    // Generate printable content for one record.
    function generateContent(record, songsMap) {
      // Helper to extract song text using the Songs map
      function extractSong(songId) {
        if (!songId) return "";
        // If songId is the object itself (from REST API sometimes)
        if (typeof songId === 'object' && songId.id) songId = songId.id;
        
        const songRec = songsMap[songId];
        return songRec ? (songRec[COL_SONG_NAME] || "") : "";
      }

      var song1 = extractSong(record[COL_SONG_1]);
      var song2 = extractSong(record[COL_SONG_2]);
      var song3 = extractSong(record[COL_SONG_3]);
      var song4 = extractSong(record[COL_SONG_4]);
      var song5 = extractSong(record[COL_SONG_5]);
      var song6 = extractSong(record[COL_SONG_6]);
      
      // Scripture readings.
      var psalm = record[COL_PSALM] || "";
      var ot = record[COL_OT] || "";
      var nt = record[COL_NT] || "";
      var gospel = record[COL_GOSPEL] || "";
      
      var content = "";
      // First three songs.
      content += "<span class='label'>Song 1:</span><span class='bigText'>" + song1 + "</span><br>";
      content += "<span class='label'>Song 2:</span><span class='bigText'>" + song2 + "</span><br>";
      content += "<span class='label'>Song 3:</span><span class='bigText'>" + song3 + "</span><br><br>";
      
      // Scripture Readings heading (full width).
      content += "<div class='scripture-heading'>Scripture Readings</div>";
      content += "<span class='label'>Psalm:</span><span class='bigText'>" + psalm + "</span><br>";
      content += "<span class='label'>OT:</span><span class='bigText'>" + ot + "</span><br>";
      // Forced page break after OT reading.
      content += "<div style='page-break-after: always;'></div>";
      content += "<span class='label'>NT:</span><span class='bigText'>" + nt + "</span><br>";
      content += "<span class='label'>Gospel:</span><span class='bigText'>" + gospel + "</span><br><br>";
      
      // Last three songs.
      content += "<span class='label'>Song 4:</span><span class='bigText'>" + song4 + "</span><br>";
      content += "<span class='label'>Song 5:</span><span class='bigText'>" + song5 + "</span><br>";
      content += "<span class='label'>Song 6:</span><span class='bigText'>" + song6 + "</span><br>";
      
      return content;
    }

    // Helper: fetch table using REST API (standalone mode)
    async function fetchTableRest(tableName) {
      const url = `https://docs.getgrist.com/api/docs/${DOC_ID}/tables/${tableName}/records`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch ${tableName}: ${response.status}`);
      const json = await response.json();
      // Map records to flatten structure: { id: 1, ...fields }
      return json.records.map(r => ({ id: r.id, ...r.fields }));
    }
    
    async function loadData() {
      try {
        let planRecords, songsRecords;

        // Try Grist Widget API first
        try {
          // Check if we are inside Grist iframe
          if (window.parent === window) throw new Error("Standalone");
          
          const [planData, songsData] = await Promise.all([
            grist.docApi.fetchTable(TABLE_PLAN),
            grist.docApi.fetchTable(TABLE_SONGS)
          ]);
          planRecords = convertToRecords(planData);
          songsRecords = convertToRecords(songsData);
        } catch (e) {
          console.log("Widget API failed or standalone mode, trying REST API...");
          [planRecords, songsRecords] = await Promise.all([
            fetchTableRest(TABLE_PLAN),
            fetchTableRest(TABLE_SONGS)
          ]);
        }

        // Index songs by ID
        const songsMap = {};
        songsRecords.forEach(s => {
            songsMap[s.id] = s;
        });

        var upcoming = getUpcomingSundayUTC();
        
        // Filter for the record whose Sunday equals the upcoming Sunday (using UTC).
        var filtered = planRecords.filter(function(rec) {
          var recDate = parseUTCDate(rec[COL_SUNDAY]);
          if (!recDate) return false;
          // Compare dates (ignoring time component if any)
          return recDate.getUTCFullYear() === upcoming.getUTCFullYear() &&
                 recDate.getUTCMonth() === upcoming.getUTCMonth() &&
                 recDate.getUTCDate() === upcoming.getUTCDate();
        });

        if (filtered.length === 0) {
          document.getElementById("output").innerHTML = "No record for the upcoming Sunday (" + upcoming.toLocaleDateString() + ").";
        } else {
          // Use the first matching record.
          document.getElementById("output").innerHTML = generateContent(filtered[0], songsMap);
        }

      } catch (err) {
        console.error(err);
        document.getElementById("output").innerHTML = "Error loading data: " + err.message + "<br><br>Make sure the document ID is correct and public access is enabled.";
      }
    }

    grist.ready({
      columns: [],
      requiredAccess: "read table"
    });
    
    loadData();
  </script>
</body>
</html>