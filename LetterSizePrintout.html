<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Printable Service Details Widget (v1.2)</title>
  <!-- External Grist API Script -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* Reset and Base Styles */
    body {
      margin: 0;
      padding: 0;
      background-color: #525659; /* Dark grey background like a PDF viewer */
      font-family: sans-serif;
      color: #000;
    }

    /* The Page Container */
    .page {
      width: 8.5in;
      min-height: 11in; /* Allow it to grow if content overflows slightly, though fixed is better for strict print preview */
      margin: 0.5in auto; /* Center on screen with spacing */
      padding: 0.75in;    /* Internal padding for content */
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Drop shadow */
      box-sizing: border-box; /* Include padding in width */
      position: relative;
    }

    /* Typography */
    h3 {
      margin-top: 0;
      font-size: 24px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    h4 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 18px;
      color: #333;
    }
    ul {
      list-style-type: disc;
      margin-left: 20px;
      margin-top: 0;
      line-height: 1.5;
    }
    li {
      margin-bottom: 5px;
    }
    p {
      margin-top: 30px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    /* Print Specific Styles */
    @media print {
      body {
        background-color: white;
        margin: 0;
      }
      .page {
        margin: 0;
        box-shadow: none;
        width: 8.5in;
        height: 11in;
        padding: 0.5in; /* Slightly reduce padding for print margin safety */
        page-break-after: always;
      }
    }
  </style>
</head>
<body>

  <div id="output">
    <div class="page" style="display: flex; align-items: center; justify-content: center;">
      Loading...
    </div>
  </div>

  <script>
    // --- Configuration ---
    const TABLE_PLAN = "Weekly_Church_Plan";
    const TABLE_SONGS = "Songs";
    const TABLE_PEOPLE = "People";
    const DOC_ID = "edUb9YnSZWnD";

    // Column Constants - Weekly_Church_Plan
    const COL_SUNDAY = "Sunday";
    const COL_PSALM = "Psalm";
    const COL_PSALM_READER = "Psalm_Reader";
    const COL_OT = "Old_Testament";
    const COL_OT_READER = "OT_Reader";
    const COL_NT = "New_Testament";
    const COL_NT_READER = "NT_Reader";
    const COL_GOSPEL = "Gospel";
    const COL_GOSPEL_READER = "Gospel_Reader";
    const COL_PRAYER_LEADER = "Prayer_Leader";
    const COL_EUCHARIST = "Eucharist";
    const COL_HOMILY = "Homily";
    const COL_CALL_TO_WORSHIP = "Call_to_Worship";
    
    // Song columns
    const COL_SONG_1 = "Song_1";
    const COL_SONG_2 = "Song_2";
    const COL_SONG_3 = "Song_3";
    const COL_SONG_4 = "Song_4";
    const COL_SONG_5 = "Song_5";
    const COL_SONG_6 = "Song_6";

    // Songs Table Columns
    const COL_SONG_NAME = "Song_Name";
    const COL_SONG_KEY = "Key";

    // People Table Columns
    const COL_PERSON_NAME = "Name";

    // Helper: Parse a "YYYY-MM-DD" string or timestamp into a Date using UTC.
    function parseUTCDate(dateInput) {
      if (!dateInput) return null;
      if (typeof dateInput === "number") {
        return new Date(dateInput * 1000);
      }
      if (typeof dateInput === "string") {
        var parts = dateInput.split("-");
        // Create a Date in UTC (month is 0-indexed).
        return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
      }
      // If already a Date, force it to UTC midnight.
      return new Date(Date.UTC(dateInput.getUTCFullYear(), dateInput.getUTCMonth(), dateInput.getUTCDate()));
    }

    // Get today's date in UTC at midnight.
    function getTodayUTC() {
      var now = new Date();
      return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    }

    // Compute the upcoming Sunday in UTC.
    function getUpcomingSundayUTC() {
      var today = getTodayUTC();
      var day = today.getUTCDay(); // 0 = Sunday, 1 = Monday, etc.
      var diff = (7 - day) % 7;
      var upcoming = new Date(today.getTime() + diff * 24 * 60 * 60 * 1000);
      return upcoming;
    }

    // Helper to convert Grist column-oriented data
    function convertToRecords(data) {
      const columns = Object.keys(data);
      if (columns.length === 0) return [];
      if (Array.isArray(data)) return data;

      const numRows = data.id ? data.id.length : 0;
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(col => {
          if (col !== 'id') {
             record[col] = data[col][i];
          }
        });
        records.push(record);
      }
      return records;
    }

    // Helper: fetch table using REST API (standalone mode)
    async function fetchTableRest(tableName) {
      const url = `https://docs.getgrist.com/api/docs/${DOC_ID}/tables/${tableName}/records`;
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Failed to fetch ${tableName}: ${response.status}`);
      const json = await response.json();
      // Map records to flatten structure: { id: 1, ...fields }
      return json.records.map(r => ({ id: r.id, ...r.fields }));
    }

    // Generate the printable HTML details for one service record.
    function generatePrintableDetails(record, songsMap, peopleMap) {
      // Helper to resolve Person Reference
      function getPersonName(personId) {
        if (!personId) return "";
        // Handle object form if present
        if (typeof personId === 'object' && personId.id) personId = personId.id;
        return peopleMap[personId] || "";
      }

      // Helper to resolve Song Reference and format as "Name (Key)"
      function getSongText(songId) {
        if (!songId) return "";
        if (typeof songId === 'object' && songId.id) songId = songId.id;
        
        const songRec = songsMap[songId];
        if (!songRec) return "";

        let name = songRec[COL_SONG_NAME] || "";
        let key = songRec[COL_SONG_KEY];
        
        if (key) {
           // Insert Key into existing parentheses if present, or append it
           var lastParenIndex = name.lastIndexOf(')');
           if (lastParenIndex !== -1 && lastParenIndex === name.length - 1) {
              return name.slice(0, lastParenIndex) + ", " + key + ")";
           }
           return name + " (" + key + ")";
        }
        return name;
      }

      var psalm = record[COL_PSALM] || "";
      var psalmReader = getPersonName(record[COL_PSALM_READER]);
      
      var oldTestament = record[COL_OT] || "";
      var otReader = getPersonName(record[COL_OT_READER]);
      
      var newTestament = record[COL_NT] || "";
      var ntReader = getPersonName(record[COL_NT_READER]);
      
      var gospel = record[COL_GOSPEL] || "";
      var gospelReader = getPersonName(record[COL_GOSPEL_READER]);
      
      var prayerLeader = getPersonName(record[COL_PRAYER_LEADER]);

      var song1 = getSongText(record[COL_SONG_1]);
      var song2 = getSongText(record[COL_SONG_2]);
      var song3 = getSongText(record[COL_SONG_3]);
      var song4 = getSongText(record[COL_SONG_4]);
      var song5 = getSongText(record[COL_SONG_5]);
      var song6 = getSongText(record[COL_SONG_6]);

      var eucharist = getPersonName(record[COL_EUCHARIST]);
      var callToWorship = getPersonName(record[COL_CALL_TO_WORSHIP]);
      var homily = getPersonName(record[COL_HOMILY]);

      var html = `
        <div class="page">
          <h3>Sunday Service Details: ${getUpcomingSundayUTC().toLocaleDateString()}</h3>

          <h4>Scripture Readings:</h4>
          <ul>
            <li><strong>Psalm:</strong> ${psalm} <em>(${psalmReader})</em></li>
            <li><strong>OT:</strong> ${oldTestament} <em>(${otReader})</em></li>
            <li><strong>NT:</strong> ${newTestament} <em>(${ntReader})</em></li>
            <li><strong>Gospel:</strong> ${gospel} <em>(${gospelReader})</em></li>
            <li><strong>Prayers of the People:</strong> ${prayerLeader}</li>
          </ul>

          <h4>Songs:</h4>
          <ul>
            <li><strong>Song 1:</strong> ${song1}</li>
            <li><strong>Song 2:</strong> ${song2}</li>
            <li><strong>Song 3:</strong> ${song3}</li>
            <li><strong>Song 4:</strong> ${song4}</li>
            <li><strong>Song 5:</strong> ${song5}</li>
            <li><strong>Song 6:</strong> ${song6}</li>
          </ul>

          <p><small><strong>Call:</strong> ${callToWorship} | <strong>Homily:</strong> ${homily} | <strong>Eucharist:</strong> ${eucharist}</small></p>
        </div>
      `;
      return html;
    }

    async function loadData() {
      try {
        let planRecords, songsRecords, peopleRecords;

        // Try Grist Widget API first
        try {
          if (window.parent === window) throw new Error("Standalone");
          
          const [planData, songsData, peopleData] = await Promise.all([
            grist.docApi.fetchTable(TABLE_PLAN),
            grist.docApi.fetchTable(TABLE_SONGS),
            grist.docApi.fetchTable(TABLE_PEOPLE)
          ]);
          planRecords = convertToRecords(planData);
          songsRecords = convertToRecords(songsData);
          peopleRecords = convertToRecords(peopleData);
        } catch (e) {
          console.log("Widget API failed or standalone mode, trying REST API...");
          [planRecords, songsRecords, peopleRecords] = await Promise.all([
            fetchTableRest(TABLE_PLAN),
            fetchTableRest(TABLE_SONGS),
            fetchTableRest(TABLE_PEOPLE)
          ]);
        }

        // Index Songs
        const songsMap = {};
        songsRecords.forEach(s => songsMap[s.id] = s);

        // Index People
        const peopleMap = {};
        peopleRecords.forEach(p => peopleMap[p.id] = p[COL_PERSON_NAME]);

        var upcoming = getUpcomingSundayUTC();
        
        // Filter for the record whose Sunday equals the upcoming Sunday (using UTC).
        var filtered = planRecords.filter(function(rec) {
          var recDate = parseUTCDate(rec[COL_SUNDAY]);
          if (!recDate) return false;
          return recDate.getUTCFullYear() === upcoming.getUTCFullYear() &&
                 recDate.getUTCMonth() === upcoming.getUTCMonth() &&
                 recDate.getUTCDate() === upcoming.getUTCDate();
        });

        if (filtered.length === 0) {
          document.getElementById("output").innerHTML = `<div class="page" style="text-align:center; padding-top: 2in;">No record found for upcoming Sunday (${upcoming.toLocaleDateString()}).</div>`;
        } else {
          var html = generatePrintableDetails(filtered[0], songsMap, peopleMap);
          document.getElementById("output").innerHTML = html;
        }

      } catch (err) {
        console.error(err);
        document.getElementById("output").innerHTML = `<div class="page" style="color:red; text-align:center; padding-top: 2in;">Error loading data: ${err.message}</div>`;
      }
    }

    // Initialize widget without column mapping
    grist.ready({
      columns: [],
      requiredAccess: 'read table'
    });

    loadData();
  </script>
</body>
</html>